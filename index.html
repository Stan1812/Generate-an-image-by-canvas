<!DOCTYPE html>
<html>
<head>
	<title>canvas练习</title>
	<meta charset="utf-8">
</head >
<style type="text/css">
	body{
		display: flex;
		flex-direction: column;	
	}
	.con{
		margin: 0 auto;
		border:2px  solid #666;
		display: inline-flex;
	}
	canvas{
		border:1px solid #666; 
		margin:10px;
	}

	.controler{
		display: flex;
		justify-content: space-around;
		margin:0 20%; 
	}
	span{		
		text-align: center;
		width: 100px;
		height: 50px;
		border:2px solid black;
		border-radius: 5px;		
		margin-top: 20px;
		line-height: 50px;
	}
	.add{
		float:left; 
		margin:0 50px; 
	}
	#confirm,#cancel{
		float: left;
		width: 100px;height: 50px;
		border:1px solid #666;
		border-radius: 5px;
		line-height: 50px;
		text-align: center;
		margin:0 20px;
		margin-top: 15px;

	}
	.intext{
		margin:0 auto; 
		margin-top: 20px;
		display: inline;
		height: 100px;
	}
	label{
		margin-top: 20px;
		width: 100px;height: 50px;
		border:1px solid #666;
		border-radius: 5px;
		line-height: 50px;
		text-align: center;
	}
	#scal{
		width: 50px;
		height: 30px;
		margin-top:40px; 
		display: none;
	}
	form{
		width: 30px;
	}
	
</style>


<body>
	<div class="con"><canvas id="canvas" height="500px" width="1000px"></canvas>
	<canvas id="canvas2" height="50px" width="100px"></canvas></div>
	<div class="intext">
		<div class="add"><textarea id="addtext" style="height:50px;width: 200px ;margin-top:15px" onBlur="if(this.value=='') this.value='在此输入要添加的文字';" onFocus=" this.value='';" />在此处输入你想要添加的文字</textarea></div>		 
		<div id="confirm">确定</div>
		<div id="cancel">取消</div>
		<!--设置文字的位置，大小，方向等信息-->
	<table>
		
		<tr>
			<th>文字其起始位置：X轴坐标</th>
			<th><input type="number" id="pos_x"></th>
		</tr>
		
		<tr>
			<th>文字其起始位置：Y轴坐标</th>
			<th><input type="number" id="pos_y"></th>
		</tr>

		<tr>
			<th>文字度数：x度</th>
			<th><input type="number" id="txt_rot"></th>
		</tr>
		<tr>
			<th>文字大小：</th>
			<th><input type="number" id="fonter"></th>
		</tr>
	</table>
	</div>

	<div class="controler">

	<input type="file" name="filename" id="uppic" style="display: none;">
	<label for="uppic" id="control1"><span id="upload">上传图片</span></label>	
	<label for="scal" onclick="document.getElementById('scal').style.display='inline'">图片缩放倍数</label>
	<input type="number" name="scal" id="scal">
	<input type="button" value="读取图像" id="read_pic" style="display: none;" onclick="readAsDataURL()">
	<label for="read_pic">读取图像</label>
	<span id="download">点击下载</span>
	
	



	</div>


<script type="text/javascript">
var canvas=document.getElementById('canvas');
var ctx=canvas.getContext('2d');


//test
var canvas2=document.getElementById('canvas2');
var ctx2=canvas2.getContext('2d');
ctx2.beginPath();
			
var addtext=document.getElementById('addtext')

//获取文本输入框的内容
//文字写入&文字删除
 var Confirm=document.getElementById('confirm');
 var Cancel=document.getElementById('cancel')
//写入文字
Confirm.addEventListener('click',function(){
	var txt=document.getElementById('addtext').value;	
	console.log(txt);


	//文字样式的设置
	//test
	var pos_x=document.getElementById('pos_x').value;
	var pos_y=document.getElementById('pos_y').value;
	var txt_rot=document.getElementById('txt_rot').value;
	var font=document.getElementById('fonter').value;
	console.log(pos_x,pos_y,txt_rot);
	ctx.save();
	ctx.font = 'bold '+fonter+'px Arial';
	ctx.fillStyle = '#058';
	ctx.fillText(txt,pos_x,pos_y);

})

//删除文字部分
//不知道该怎样只把文字给删掉而不断删掉整个图片
Cancel.addEventListener('click',function(){
	console.log("laji")
	ctx.clearRect(0,0,1000000,1000000)
})



//上传和下载按钮
var but1=document.getElementById('upload');			
var btn2=document.getElementById('download');


var pic1=document.getElementById('uppic').value;
console.log(pic1)

//将生成的文字图片生成像素数据，然后写入到大图上
var imgdata=ctx2.getImageData(0,0,50,500);

ctx.putImageData(imgdata,0,0);


var picwidth=100;
var picheight=100;
//上传图片模块
  function readAsDataURL(){
    //检验是否为图像文件
    var file = document.getElementById("uppic").files[0];
    if(!/image\/\w+/.test(file.type)){
        alert('图片');
        return false;
    }
    var reader = new FileReader();
    //将文件以Data URL形式读入页面
    reader.readAsDataURL(file);
    reader.onload=function(e){
        var picture=this.result;
       	var pic=new Image();
       	pic.src=picture;    
       	
       	ctx.scale(0.8,0.8);
       	ctx.drawImage(pic,0,0)

    }
}


//下载模块
btn2.addEventListener('click',function(){
	var type='jpg';
	download(type)
})
//图片下载操作,指定图片类型
function download(type) {

    //设置保存图片的类型
    var imgdata = canvas.toDataURL(type);
    
    //将mime-type改为image/octet-stream,强制让浏览器下载
    var fixtype = function (type) {
        type = type.toLocaleLowerCase().replace(/jpg/i, 'jpeg');
        var r = type.match(/png|jpeg|bmp|gif/)[0];
        return 'image/' + r;
    }
    imgdata = imgdata.replace(fixtype(type), 'image/octet-stream')
    
    //将图片保存到本地
    var saveFile = function (data, filename) {
        var link = document.createElement('a');
        link.href = data;
        link.download = filename;
        var event = document.createEvent('MouseEvents');
        event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
        link.dispatchEvent(event);
        ctx.scale(1,1);
        console.log(canvas.width,canvas.height)
    }
    var filename = new Date().toLocaleDateString() + '.' + type;
    saveFile(imgdata, filename);
}
	</script>
</body>
</html> 